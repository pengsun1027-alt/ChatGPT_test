<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>设备巡检系统 - 点检执行</title>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
					sans-serif;
				background: #f7f8fa;
			}
			.safe-bottom {
				padding-bottom: max(env(safe-area-inset-bottom), 0.75rem);
			}
		</style>
	</head>
	<body>
		<!-- 顶部导航栏 -->
		<header
			class="fixed inset-x-0 top-0 h-12 bg-white/90 backdrop-blur shadow-sm flex items-center justify-between px-4 z-50"
		>
			<button class="w-8 h-8 flex items-center justify-center" onclick="history.back()">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
			</button>
			<h1 class="text-base font-semibold">点检执行 · 供水泵#1</h1>
			<span class="text-xs text-slate-500">批次 2025W33</span>
		</header>

		<!-- 扫码状态栏 -->
		<div id="scanbar" class="fixed inset-x-0 top-12 bg-white border-b border-slate-200 z-40">
			<div class="flex items-center justify-between px-4 py-3">
				<div class="flex items-center space-x-3">
					<div class="w-2 h-2 bg-slate-400 rounded-full"></div>
					<div>
						<div id="scan-text" class="text-sm font-medium text-slate-800">未扫码</div>
						<div id="scan-desc" class="text-xs text-slate-500">到点后解锁提交</div>
					</div>
				</div>
				<button
					class="px-3 py-1 text-white text-sm font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200"
					style="background-color: #2563eb"
					onclick="toggleScan()"
				>
					去扫码
				</button>
			</div>
		</div>

		<!-- 主要内容区域 -->
		<main class="mt-28 px-4 pb-20 space-y-4">
			<!-- 实例选择卡片 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-3">
					<h3 class="font-semibold text-slate-800">选择今日时窗</h3>
					<span class="text-xs text-slate-500">时窗列表</span>
				</div>
				<div id="chips" class="flex flex-wrap gap-2 mb-2">
					<button
						class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 cursor-pointer"
						data-key="08:00-09:00"
						data-state="DONE"
					>
						08:00–09:00 · 已完成
					</button>
					<button
						class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-200 cursor-pointer active"
						data-key="12:00-13:00"
						data-state="OPEN"
					>
						12:00–13:00 · 可开始
					</button>
					<button
						class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 cursor-pointer"
						data-key="18:00-19:00"
						data-state="NOT_YET"
					>
						18:00–19:00 · 未到时间
					</button>
				</div>
				<div id="instTips" class="text-xs text-slate-500">当前实例：12:00–13:00 · 可开始</div>
			</div>
			<!-- 项目1：外观检查 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-4">
					<h3 class="font-semibold text-slate-800">外观检查</h3>
					<span
						id="tag1"
						class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600"
					>
						<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>未填
					</span>
				</div>

				<div class="flex space-x-3 mb-3" data-name="p1" onclick="selectRadio(event)">
					<button
						class="px-4 py-2 border text-white rounded-full text-sm font-semibold active transition-all duration-200"
						style="background-color: #2563eb; border-color: #2563eb"
						data-value="正常"
					>
						正常
					</button>
					<button
						class="px-4 py-2 border border-slate-300 text-slate-600 rounded-full text-sm font-semibold transition-all duration-200"
						data-value="故障"
					>
						故障
					</button>
				</div>

				<div class="text-xs text-slate-500 mb-4">说明：查看外观有无破损、漏液</div>

				<div class="flex justify-between mt-4">
					<button
						class="text-sm text-slate-500 underline transition-all duration-200"
						onclick="openCantModal(1,'外观检查')"
					>
						无法完成
					</button>
					<button
						id="btn1"
						class="px-4 py-2 text-white text-sm font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200"
						style="background-color: #2563eb"
						onclick="submitSection('1')"
					>
						提交本项目
					</button>
				</div>
			</div>

			<!-- 项目2：运转声音 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-4">
					<h3 class="font-semibold text-slate-800">运转声音</h3>
					<span
						id="tag2"
						class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600"
					>
						<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>未填
					</span>
				</div>

				<div class="flex space-x-3 mb-3" data-name="p2" onclick="selectRadio(event)">
					<button
						class="px-4 py-2 border text-white rounded-full text-sm font-semibold active transition-all duration-200"
						style="background-color: #2563eb; border-color: #2563eb"
						data-value="正常"
					>
						正常
					</button>
					<button
						class="px-4 py-2 border border-slate-300 text-slate-600 rounded-full text-sm font-semibold transition-all duration-200"
						data-value="故障"
					>
						故障
					</button>
				</div>

				<div class="text-xs text-slate-500 mb-4">说明：有无异常摩擦/敲击声</div>

				<div class="flex justify-between mt-4">
					<button
						class="text-sm text-slate-500 underline transition-all duration-200"
						onclick="openCantModal(2,'运转声音')"
					>
						无法完成
					</button>
					<button
						id="btn2"
						class="px-4 py-2 text-white text-sm font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200"
						style="background-color: #2563eb"
						onclick="submitSection('2')"
					>
						提交本项目
					</button>
				</div>
			</div>

			<!-- 项目3：安全防护 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-4">
					<h3 class="font-semibold text-slate-800">安全防护</h3>
					<span
						id="tag3"
						class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600"
					>
						<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>未填
					</span>
				</div>

				<div class="flex space-x-3 mb-3" data-name="p3" onclick="selectRadio(event)">
					<button
						class="px-4 py-2 border text-white rounded-full text-sm font-semibold active transition-all duration-200"
						style="background-color: #2563eb; border-color: #2563eb"
						data-value="正常"
					>
						正常
					</button>
					<button
						class="px-4 py-2 border border-slate-300 text-slate-600 rounded-full text-sm font-semibold transition-all duration-200"
						data-value="故障"
					>
						故障
					</button>
				</div>

				<div class="text-xs text-slate-500 mb-4">说明：防护罩/护栏是否完整可靠</div>

				<div class="flex justify-between mt-4">
					<button
						class="text-sm text-slate-500 underline transition-all duration-200"
						onclick="openCantModal(3,'安全防护')"
					>
						无法完成
					</button>
					<button
						id="btn3"
						class="px-4 py-2 text-white text-sm font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200"
						style="background-color: #2563eb"
						onclick="submitSection('3')"
					>
						提交本项目
					</button>
				</div>
			</div>
		</main>

		<!-- 底部操作栏 -->
		<div class="fixed inset-x-0 bottom-0 bg-white/95 backdrop-blur border-t border-slate-200 safe-bottom z-50">
			<div class="px-4 py-3 flex space-x-3">
				<button
					class="flex-1 py-3 bg-slate-100 text-slate-700 font-medium rounded hover:bg-slate-200 active:bg-slate-300 transition-all duration-200"
				>
					保存草稿
				</button>
				<button
					id="submitAll"
					class="flex-1 py-3 bg-slate-300 text-slate-500 font-semibold rounded transition-all duration-200"
					onclick="submitAll()"
					disabled
				>
					批量提交
				</button>
			</div>
		</div>

		<!-- 底部弹窗 - 无法完成 -->
		<div id="cant-modal" class="fixed inset-0 bg-black/50 hidden items-end z-50">
			<div class="bg-white rounded-t-2xl w-full p-6">
				<h3 id="cant-title" class="text-lg font-semibold mb-4">项目无法完成</h3>
				<div class="flex flex-wrap gap-2 mb-4">
					<button
						class="px-3 py-1 border border-slate-300 rounded-full text-sm font-semibold hover:bg-slate-50 transition-all duration-200"
					>
						无法接近测点
					</button>
					<button
						class="px-3 py-1 border border-slate-300 rounded-full text-sm font-semibold hover:bg-slate-50 transition-all duration-200"
					>
						仪表损坏
					</button>
					<button
						class="px-3 py-1 border border-slate-300 rounded-full text-sm font-semibold hover:bg-slate-50 transition-all duration-200"
					>
						工况不允许
					</button>
					<button
						class="px-3 py-1 border border-slate-300 rounded-full text-sm font-semibold hover:bg-slate-50 transition-all duration-200"
					>
						其他
					</button>
				</div>
				<textarea
					id="cant-reason"
					class="w-full min-h-20 border border-slate-300 rounded p-3 text-sm resize-none"
					placeholder="请补充具体原因（必填）"
				></textarea>
				<div class="flex space-x-3 mt-4">
					<button
						class="flex-1 py-3 bg-slate-100 text-slate-700 font-medium rounded hover:bg-slate-200 transition-all duration-200"
						onclick="closeCantModal()"
					>
						取消
					</button>
					<button
						class="flex-1 py-3 text-white font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200"
						style="background-color: #2563eb"
						onclick="submitCant()"
					>
						提交原因
					</button>
				</div>
			</div>
		</div>

		<script>
			let scanned = false;
			let currentState = 'OPEN';

			function setInstanceState(state, key) {
				currentState = state;
				const tips = document.getElementById('instTips');
				tips.textContent =
					'当前实例：' +
					key.replace('-', '–') +
					' · ' +
					{ OPEN: '可开始', NOT_YET: '未到时间', DONE: '已完成' }[state];
				updateLocks();
			}

			// 实例芯片点击
			Array.from(document.querySelectorAll('#chips button')).forEach((chip) => {
				chip.addEventListener('click', () => {
					Array.from(document.querySelectorAll('#chips button')).forEach((x) => {
						x.style.backgroundColor = '';
						x.style.color = '';
						x.style.borderColor = '';
						x.classList.remove('text-white', 'text-blue-700', 'bg-blue-100', 'border', 'border-blue-200');
						x.classList.add('bg-slate-100', 'text-slate-600');
					});
					chip.classList.remove('bg-slate-100', 'text-slate-600');
					chip.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-200');
					setInstanceState(chip.dataset.state, chip.dataset.key);
				});
			});

			function toggleScan() {
				scanned = !scanned;
				const scanbar = document.getElementById('scanbar');
				const dot = scanbar.querySelector('.w-2');
				const scanText = document.getElementById('scan-text');
				const scanDesc = document.getElementById('scan-desc');

				if (scanned) {
					dot.className = 'w-2 h-2 bg-green-500 rounded-full';
					scanText.textContent = '已扫码';
					scanDesc.textContent = '现场到点 · 09:40 · 距离 3m';
				} else {
					dot.className = 'w-2 h-2 bg-slate-400 rounded-full';
					scanText.textContent = '未扫码';
					scanDesc.textContent = '到点后解锁提交';
				}
				updateLocks();
			}

			function selectRadio(e) {
				const btn = e.target.closest('button[data-value]');
				if (!btn) return;

				const group = btn.parentNode;
				[...group.children].forEach((b) => {
					b.style.backgroundColor = '';
					b.style.borderColor = '';
					b.classList.remove('text-white');
					b.classList.add('border-slate-300', 'text-slate-600');
				});

				btn.classList.remove('border-slate-300', 'text-slate-600');
				btn.classList.add('text-white');
				btn.style.backgroundColor = '#2563EB';
				btn.style.borderColor = '#2563EB';

				const name = group.getAttribute('data-name');
				const val = btn.getAttribute('data-value');
				const extra = document.getElementById(name + '-extra');

				if (extra) {
					if (val === '故障') {
						extra.classList.remove('hidden');
					} else {
						extra.classList.add('hidden');
					}
				}
				updateLocks();
			}

			function addPhoto(id) {
				const wrap = document.getElementById(id);
				const ph = document.createElement('div');
				ph.className = 'w-20 h-20 bg-slate-100 rounded flex items-center justify-center text-xs text-slate-600';
				ph.textContent = 'IMG';
				wrap.insertBefore(ph, wrap.lastElementChild);
				const count = parseInt(wrap.getAttribute('data-count') || '0') + 1;
				wrap.setAttribute('data-count', count);
				updateLocks();
			}

			function tagState(idx) {
				const el = document.getElementById('tag' + idx);
				if (el.classList.contains('bg-green-100')) return 'GREEN';
				if (el.classList.contains('bg-red-100')) return 'RED';
				return 'NONE';
			}

			function sectionValid(idx) {
				const ts = tagState(idx);
				if (ts === 'GREEN' || ts === 'RED') return true;
				if (currentState !== 'OPEN') return false;
				if (!scanned) return false;

				const group = document.querySelector(`[data-name="p${idx}"]`);
				const active = group.querySelector('.text-white').getAttribute('data-value');
				if (active === '正常') return true;

				const photos = parseInt(document.getElementById(`p${idx}-photos`).getAttribute('data-count') || '0');
				const remark = document.getElementById(`p${idx}-remark`).value.trim();
				return photos >= 1 && remark.length > 0;
			}

			function updateLocks() {
				[1, 2, 3].forEach((i) => {
					const btn = document.getElementById('btn' + i);
					const isValid = sectionValid(i);
					btn.disabled = !isValid;
					if (!isValid) {
						btn.className =
							'px-4 py-2 text-slate-500 text-sm font-semibold rounded transition-all duration-200';
						btn.style.backgroundColor = '#d1d5db';
					} else {
						btn.className =
							'px-4 py-2 text-white text-sm font-semibold rounded hover:opacity-90 hover:-translate-y-px transition-all duration-200';
						btn.style.backgroundColor = '#2563eb';
					}
				});

				const all = [1, 2, 3].every(sectionValid);
				const submitAllBtn = document.getElementById('submitAll');
				submitAllBtn.disabled = !all;
				if (!all) {
					submitAllBtn.className =
						'flex-1 py-3 bg-slate-300 text-slate-500 font-semibold rounded transition-all duration-200';
					submitAllBtn.style.backgroundColor = '';
				} else {
					submitAllBtn.className =
						'flex-1 py-3 text-white font-semibold rounded hover:opacity-90 hover:-translate-y-px active:opacity-75 transition-all duration-200';
					submitAllBtn.style.backgroundColor = '#2563eb';
				}

				if (currentState === 'NOT_YET') {
					document.getElementById('scan-desc').textContent = '未到时间，待时窗生效后可扫码';
				} else if (!scanned) {
					document.getElementById('scan-desc').textContent = '到点后解锁提交';
				}
			}

			function submitSection(idx) {
				if (!sectionValid(idx)) return alert('未满足提交条件');

				const tag = document.getElementById('tag' + idx);
				tag.className =
					'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
				tag.innerHTML = '<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>已提交';

				alert('项目 ' + idx + ' 提交成功');
				updateLocks();
			}

			function submitAll() {
				alert('批量提交成功：3/3');
				['tag1', 'tag2', 'tag3'].forEach((id) => {
					const el = document.getElementById(id);
					el.className =
						'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
					el.innerHTML = '<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>已提交';
				});
				updateLocks();
			}

			let cantIdx = null;
			let cantName = '';

			function openCantModal(idx, name) {
				cantIdx = idx;
				cantName = name;
				document.getElementById('cant-title').textContent = '项目无法完成 · ' + name;
				document.getElementById('cant-modal').classList.remove('hidden');
				document.getElementById('cant-modal').classList.add('flex');
			}

			function closeCantModal() {
				document.getElementById('cant-modal').classList.add('hidden');
				document.getElementById('cant-modal').classList.remove('flex');
			}

			function submitCant() {
				const reason = document.getElementById('cant-reason').value.trim();
				if (!reason) {
					alert('请填写原因');
					return;
				}

				const tag = document.getElementById('tag' + cantIdx);
				tag.className =
					'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700';
				tag.innerHTML = '<span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>无法完成';

				const btn = document.getElementById('btn' + cantIdx);
				if (btn) btn.disabled = true;

				closeCantModal();
				updateLocks();
				alert('已记录无法完成：' + cantName + '；原因：' + reason);
				document.getElementById('cant-reason').value = '';
			}

			// 初始化
			setInstanceState('OPEN', '12:00-13:00');
			updateLocks();
		</script>
	</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
		<title>点检执行（两页版·含实例选择+扫码）</title>
		<style>
			:root {
				--primary: #2b6fff;
				--primary-active: #1c54f0;
				--primary-subtle: #e8eeff;
				--success: #22c55e;
				--warning: #f59e0b;
				--danger: #ef4444;
				--text: #0f172a;
				--muted: #64748b;
				--border: #e2e8f0;
				--bg: #f8fafc;
				--card: #ffffff;
				--shadow: 0 6px 16px rgba(16, 24, 40, 0.06);
			}
			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}
			body {
				margin: 0;
				padding: 0;
				background: var(--bg);
				color: var(--text);
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', Roboto, Arial;
				font-size: 16px;
				line-height: 1.5;
				/* 禁用纵向滚动条但保留滚动功能 */
				overflow-y: scroll;
			}
			/* Firefox 隐藏滚动条 */
			html {
				scrollbar-width: none;
			}

			/* 隐藏滚动条 */
			::-webkit-scrollbar {
				width: 0;
				background: transparent;
			}

			/* IE/Edge 隐藏滚动条 */
			-ms-overflow-style: none;
			a {
				color: inherit;
				text-decoration: none;
			}
			.container {
				padding: 16px 16px 88px 16px;
			}
			.navbar {
				position: sticky;
				top: 0;
				z-index: 10;
				background: #fff;
				padding: 12px 16px;
				border-bottom: 1px solid var(--border);
				display: flex;
				align-items: center;
				gap: 12px;
			}
			.navbar .title {
				font-weight: 600;
				font-size: 18px;
			}
			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				height: 44px;
				padding: 0 16px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: #fff;
				font-weight: 600;
			}
			.btn-small {
				height: 32px;
				padding: 0 12px;
				border-radius: 10px;
				font-size: 14px;
			}
			.btn-primary {
				background: var(--primary);
				border-color: var(--primary);
				color: #fff;
			}
			.btn-primary:disabled {
				background: #9db8ff;
				border-color: #9db8ff;
			}
			.section {
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 12px;
				box-shadow: var(--shadow);
				padding: 12px;
				margin: 4px 0;
			}
			.sec-head {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			.sec-title {
				font-weight: 700;
			}
			.chip {
				padding: 8px 12px;
				border: 1px solid var(--border);
				border-radius: 999px;
				background: #fff;
				font-size: 14px;
				white-space: nowrap;
			}
			.chip.active {
				background: var(--primary-subtle);
				border-color: var(--primary);
				color: var(--primary);
			}
			.chip.gray {
				color: #475569;
			}
			.chip.green {
				border-color: #22c55e;
				color: #22c55e;
			}
			.chip.red {
				border-color: var(--danger);
				color: var(--danger);
			}
			.scanbar {
				position: sticky;
				top: 54px;
				background: #fff;
				border-bottom: 1px solid var(--border);
				z-index: 9;
				padding: 10px 16px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 12px;
			}
			.scanbar .state {
				display: flex;
				align-items: center;
				gap: 8px;
				font-weight: 600;
			}
			.scanbar .dot {
				width: 10px;
				height: 10px;
				border-radius: 999px;
				background: var(--muted);
			}
			.scanbar.scanned .dot {
				background: var(--success);
			}
			.scanbar .desc {
				font-size: 12px;
				color: var(--muted);
			}
			.tag {
				font-size: 12px;
				padding: 4px 8px;
				border-radius: 999px;
				border: 1px solid var(--border);
			}
			.tag.green {
				border-color: var(--success);
				color: var(--success);
			}
			.tag.red {
				border-color: var(--danger);
				color: var(--danger);
			}
			.tag.yellow {
				border-color: var(--warning);
				color: var(--warning);
			}
			.photo-uploader {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
			}
			.photo {
				width: 72px;
				height: 72px;
				border-radius: 8px;
				border: 1px dashed var(--border);
				display: flex;
				align-items: center;
				justify-content: center;
				color: var(--muted);
				font-size: 12px;
				cursor: pointer;
			}
			.radio-group {
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
			}
			.radio {
				display: flex;
				align-items: center;
				gap: 6px;
				padding: 8px 10px;
				border: 1px solid var(--border);
				border-radius: 999px;
			}
			.radio.active {
				border-color: var(--primary);
				color: var(--primary);
			}
			.textarea {
				width: 100%;
				min-height: 80px;
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 8px;
			}
			.bottom-affix {
				position: fixed;
				left: 0;
				right: 0;
				bottom: 0;
				background: #fff;
				border-top: 1px solid var(--border);
				padding: 12px 16px;
				display: flex;
				gap: 8px;
				z-index: 20;
			}
			.bottom-affix .btn {
				flex: 1;
			}
			.small {
				font-size: 12px;
				color: var(--muted);
			}
			.actions {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: 8px;
			}
			.btn-text {
				background: transparent;
				border: none;
				padding: 0;
				font-size: 12px;
				color: var(--muted);
				text-decoration: underline;
				cursor: pointer;
			}
			/* modal styles */
			.modal-backdrop {
				position: fixed;
				inset: 0;
				background: rgba(15, 23, 42, 0.45);
				display: none;
				align-items: flex-end;
				z-index: 99;
			}
			.modal {
				width: 100%;
				background: #fff;
				border-top-left-radius: 16px;
				border-top-right-radius: 16px;
				padding: 16px;
				border: 1px solid var(--border);
				box-shadow: var(--shadow);
			}
			.modal h3 {
				margin: 0 0 8px 0;
				font-size: 16px;
			}
			.modal .row {
				display: flex;
				gap: 8px;
				margin: 8px 0;
				flex-wrap: wrap;
			}
			.modal .chip {
				padding: 6px 10px;
				border-radius: 999px;
				border: 1px solid var(--border);
			}
			.modal textarea {
				width: 100%;
				min-height: 80px;
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 8px;
			}
			.modal .actions {
				display: flex;
				gap: 8px;
				margin-top: 12px;
			}
			.modal .actions .btn {
				flex: 1;
			}
		</style>
	</head>
	<body>
		<div class="navbar">
			<div class="title">点检 · 执行（供水泵#1）</div>
			<div style="margin-left: auto" class="small">批次 2025W33</div>
		</div>

		<!-- 扫码卡片（两页版：置于最上方，位于实例选择之上） -->
		<div id="scanbar" class="scanbar">
			<div>
				<div class="state">
					<div class="dot"></div>
					<div id="scan-text">未扫码</div>
				</div>
				<div class="desc" id="scan-desc">到点后解锁提交</div>
			</div>
			<button class="btn btn-small" onclick="toggleScan()">去扫码</button>
		</div>

		<!-- 实例选择（两页版：页首，仅次于扫码卡片） -->
		<div class="section" id="instance">
			<div class="sec-head">
				<div class="sec-title">选择今日实例</div>
				<div class="small">时窗</div>
			</div>
			<div id="chips" style="display: flex; gap: 8px; flex-wrap: wrap">
				<div class="chip" data-key="08:00-09:00" data-state="DONE">08:00–09:00 · 已完成</div>
				<div class="chip active" data-key="12:00-13:00" data-state="OPEN">12:00–13:00 · 可开始</div>
				<div class="chip gray" data-key="18:00-19:00" data-state="NOT_YET">18:00–19:00 · 未到时间</div>
			</div>
			<div id="instTips" class="small" style="margin-top: 6px">当前实例：12:00–13:00 · 可开始</div>
		</div>

		<div class="container">
			<!-- 项目1：外观检查 -->
			<div class="section" data-required="true">
				<div class="sec-head">
					<div class="sec-title">外观检查</div>
					<div class="tag" id="tag1">未填</div>
				</div>
				<div class="radio-group" data-name="p1" onclick="selectRadio(event)">
					<div class="radio active" data-value="正常">正常</div>
					<div class="radio" data-value="故障">故障</div>
				</div>
				<div class="small" style="margin-top: 6px">说明：查看外观有无破损、漏液。</div>
				<div class="small" id="p1-extra" style="display: none; margin-top: 8px">
					<div class="small" style="margin-bottom: 6px">
						照片<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<div class="photo-uploader" data-min="1" data-count="0" id="p1-photos">
						<div class="photo" onclick="addPhoto('p1-photos')">+ 照片</div>
					</div>
					<div class="small" style="margin: 8px 0 6px 0">
						备注<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<textarea class="textarea" placeholder="请填写故障现象" id="p1-remark"></textarea>
				</div>
				<div class="actions">
					<button class="btn-text" onclick="openCantModal(1,'外观检查')">无法完成</button>
					<button class="btn btn-small btn-primary" onclick="submitSection('1')" id="btn1">提交本项目</button>
				</div>
			</div>

			<!-- 项目2：运转声音 -->
			<div class="section" data-required="true">
				<div class="sec-head">
					<div class="sec-title">运转声音</div>
					<div class="tag" id="tag2">未填</div>
				</div>
				<div class="radio-group" data-name="p2" onclick="selectRadio(event)">
					<div class="radio active" data-value="正常">正常</div>
					<div class="radio" data-value="故障">故障</div>
				</div>
				<div class="small" style="margin-top: 6px">说明：有无异常摩擦/敲击声。</div>
				<div class="small" id="p2-extra" style="display: none; margin-top: 8px">
					<div class="small" style="margin-bottom: 6px">
						照片<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<div class="photo-uploader" data-min="1" data-count="0" id="p2-photos">
						<div class="photo" onclick="addPhoto('p2-photos')">+ 照片</div>
					</div>
					<div class="small" style="margin: 8px 0 6px 0">
						备注<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<textarea class="textarea" placeholder="请填写故障现象" id="p2-remark"></textarea>
				</div>
				<div class="actions">
					<button class="btn-text" onclick="openCantModal(2,'运转声音')">无法完成</button>
					<button class="btn btn-small btn-primary" onclick="submitSection('2')" id="btn2">提交本项目</button>
				</div>
			</div>

			<!-- 项目3：安全防护 -->
			<div class="section" data-required="true">
				<div class="sec-head">
					<div class="sec-title">安全防护</div>
					<div class="tag" id="tag3">未填</div>
				</div>
				<div class="radio-group" data-name="p3" onclick="selectRadio(event)">
					<div class="radio active" data-value="正常">正常</div>
					<div class="radio" data-value="故障">故障</div>
				</div>
				<div class="small" style="margin-top: 6px">说明：防护罩/护栏是否完整可靠。</div>
				<div class="small" id="p3-extra" style="display: none; margin-top: 8px">
					<div class="small" style="margin-bottom: 6px">
						照片<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<div class="photo-uploader" data-min="1" data-count="0" id="p3-photos">
						<div class="photo" onclick="addPhoto('p3-photos')">+ 照片</div>
					</div>
					<div class="small" style="margin: 8px 0 6px 0">
						备注<span style="color: var(--danger); margin-left: 4px">*</span>
					</div>
					<textarea class="textarea" placeholder="请填写故障现象" id="p3-remark"></textarea>
				</div>
				<div class="actions">
					<button class="btn-text" onclick="openCantModal(3,'安全防护')">无法完成</button>
					<button class="btn btn-small btn-primary" onclick="submitSection('3')" id="btn3">提交本项目</button>
				</div>
			</div>
		</div>

		<div class="bottom-affix">
			<button class="btn">保存草稿</button>
			<button id="submitAll" class="btn btn-primary" disabled onclick="submitAll()">批量提交</button>
		</div>

		<!-- 无法完成：弹窗（两页版） -->
		<div
			id="cant-modal"
			class="modal-backdrop"
			style="
				position: fixed;
				inset: 0;
				background: rgba(15, 23, 42, 0.45);
				display: none;
				align-items: flex-end;
				z-index: 99;
			"
		>
			<div class="modal" style="width: 100%">
				<h3 id="cant-title">项目无法完成</h3>
				<div class="row" style="display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap">
					<div class="chip">无法接近测点</div>
					<div class="chip">仪表损坏</div>
					<div class="chip">工况不允许</div>
					<div class="chip">其他</div>
				</div>
				<textarea
					id="cant-reason"
					placeholder="请补充具体原因（必填）"
					style="
						width: 100%;
						min-height: 80px;
						border: 1px solid var(--border);
						border-radius: 10px;
						padding: 8px;
					"
				></textarea>
				<div class="actions">
					<button class="btn" onclick="closeCantModal()">取消</button
					><button class="btn btn-primary" onclick="submitCant()">提交原因</button>
				</div>
			</div>
		</div>

		<script>
			let scanned = false; // 扫码状态
			let currentState = 'OPEN'; // 实例状态：OPEN | NOT_YET | DONE

			function setInstanceState(state, key) {
				currentState = state;
				const tips = document.getElementById('instTips');
				tips.textContent =
					'当前实例：' +
					key.replace('-', '–') +
					' · ' +
					{ OPEN: '可开始', NOT_YET: '未到时间', DONE: '已完成' }[state];
				updateLocks();
			}

			// 实例芯片点击
			Array.from(document.querySelectorAll('#chips .chip')).forEach((ch) => {
				ch.addEventListener('click', () => {
					Array.from(document.querySelectorAll('#chips .chip')).forEach((x) => x.classList.remove('active'));
					ch.classList.add('active');
					setInstanceState(ch.dataset.state, ch.dataset.key);
				});
			});

			function toggleScan() {
				scanned = !scanned;
				const sb = document.getElementById('scanbar');
				if (scanned) {
					sb.classList.add('scanned');
					document.getElementById('scan-text').textContent = '已扫码';
					document.getElementById('scan-desc').textContent = '现场到点 · 09:40 · 距离 3m';
				} else {
					sb.classList.remove('scanned');
					document.getElementById('scan-text').textContent = '未扫码';
					document.getElementById('scan-desc').textContent = '到点后解锁提交';
				}
				updateLocks();
			}

			function selectRadio(e) {
				const btn = e.target.closest('.radio');
				if (!btn) return;
				const group = btn.parentNode;
				[...group.children].forEach((r) => r.classList.remove('active'));
				btn.classList.add('active');
				const name = group.getAttribute('data-name');
				const val = btn.getAttribute('data-value');
				const extra = document.getElementById(name + '-extra');
				if (extra) {
					extra.style.display = val === '故障' ? 'block' : 'none';
				}
				updateLocks();
			}

			function addPhoto(id) {
				const wrap = document.getElementById(id);
				const ph = document.createElement('div');
				ph.className = 'photo';
				ph.textContent = 'IMG';
				wrap.insertBefore(ph, wrap.lastElementChild);
				const count = parseInt(wrap.getAttribute('data-count') || '0') + 1;
				wrap.setAttribute('data-count', count);
				updateLocks();
			}

			function tagState(idx) {
				const el = document.getElementById('tag' + idx);
				if (!el) return 'NONE';
				if (el.classList.contains('green')) return 'GREEN';
				if (el.classList.contains('red')) return 'RED';
				return 'NONE';
			}

			function sectionValid(idx) {
				// 若已“已提交”或“无法完成”，视为已完成（允许批量提交）
				const ts = tagState(idx);
				if (ts === 'GREEN' || ts === 'RED') return true;
				if (currentState !== 'OPEN') return false; // 非可开始实例，禁用
				if (!scanned) return false; // 未扫码，禁用
				const group = document.querySelector(`[data-name="p${idx}"]`);
				const active = group.querySelector('.active').getAttribute('data-value');
				if (active === '正常') return true;
				const photos = parseInt(document.getElementById(`p${idx}-photos`).getAttribute('data-count') || '0');
				const remark = document.getElementById(`p${idx}-remark`).value.trim();
				return photos >= 1 && remark.length > 0;
			}

			function updateLocks() {
				// 单项按钮
				[1, 2, 3].forEach((i) => {
					const btn = document.getElementById('btn' + i);
					btn.disabled = !sectionValid(i);
				});
				// 批量按钮：全部有效
				const all = [1, 2, 3].every(sectionValid);
				document.getElementById('submitAll').disabled = !all;
				const sb = document.getElementById('scanbar');
				if (currentState === 'NOT_YET') {
					document.getElementById('scan-desc').textContent = '未到时间，待时窗生效后可扫码';
				} else if (!scanned) {
					document.getElementById('scan-desc').textContent = '到点后解锁提交';
				}
			}

			function submitSection(idx) {
				if (!sectionValid(idx)) return alert('未满足提交条件');
				document.getElementById('tag' + idx).className = 'tag green';
				document.getElementById('tag' + idx).textContent = '已提交';
				alert('项目 ' + idx + ' 提交成功');
				updateLocks();
			}
			function submitAll() {
				alert('批量提交成功：3/3');
				['tag1', 'tag2', 'tag3'].forEach((id) => {
					const el = document.getElementById(id);
					el.className = 'tag green';
					el.textContent = '已提交';
				});
				updateLocks();
			}

			// 无法完成弹窗逻辑
			let cantIdx = null;
			let cantName = '';
			function openCantModal(idx, name) {
				cantIdx = idx;
				cantName = name;
				document.getElementById('cant-title').textContent = '项目无法完成 · ' + name;
				document.getElementById('cant-modal').style.display = 'flex';
			}
			function closeCantModal() {
				document.getElementById('cant-modal').style.display = 'none';
			}
			function submitCant() {
				const reason = document.getElementById('cant-reason').value.trim();
				if (!reason) {
					alert('请填写原因');
					return;
				}
				const tag = document.getElementById('tag' + cantIdx);
				tag.className = 'tag red';
				tag.textContent = '无法完成';
				const btn = document.getElementById('btn' + cantIdx);
				if (btn) btn.disabled = true;
				closeCantModal();
				updateLocks();
				alert('已记录无法完成：' + cantName + '；原因：' + reason);
				document.getElementById('cant-reason').value = '';
			}

			// 初始化
			setInstanceState('OPEN', '12:00-13:00');
			updateLocks();
		</script>
	</body>
</html>

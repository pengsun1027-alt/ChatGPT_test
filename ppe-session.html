<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>PPE 会话采集</title>
		<style>
			:root {
				--primary: #2b6fff;
				--primary-active: #1c54f0;
				--primary-subtle: #e8eeff;
				--success: #22c55e;
				--warning: #f59e0b;
				--danger: #ef4444;
				--text: #0f172a;
				--muted: #64748b;
				--border: #e2e8f0;
				--bg: #f8fafc;
				--card: #ffffff;
				--shadow: 0 6px 16px rgba(16, 24, 40, 0.06);
			}
			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}
			body {
				margin: 0;
				padding: 0;
				background: var(--bg);
				color: var(--text);
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', Roboto, Arial;
				font-size: 16px;
				line-height: 1.5;
				/* 禁用纵向滚动条但保留滚动功能 */
				overflow-y: scroll;
			}
			/* Firefox 隐藏滚动条 */
			html {
				scrollbar-width: none;
			}

			/* 隐藏滚动条 */
			::-webkit-scrollbar {
				width: 0;
				background: transparent;
			}

			/* IE/Edge 隐藏滚动条 */
			-ms-overflow-style: none;

			a {
				color: inherit;
				text-decoration: none;
			}
			.container {
				padding: 16px 16px 120px 16px;
			}
			.navbar {
				position: sticky;
				top: 0;
				z-index: 10;
				background: #fff;
				padding: 12px 16px;
				border-bottom: 1px solid var(--border);
				display: flex;
				align-items: center;
				gap: 12px;
			}
			.navbar .title {
				font-weight: 600;
				font-size: 18px;
			}
			.card {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 12px;
				box-shadow: var(--shadow);
			}
			.card + .card {
				margin-top: 12px;
			}
			.section {
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 12px;
				box-shadow: var(--shadow);
				padding: 12px;
				margin: 12px 0;
			}
			.sec-head {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			.sec-title {
				font-weight: 700;
			}
			.row {
				display: flex;
				gap: 8px;
				align-items: center;
			}
			.pill {
				font-size: 14px;
				border-radius: 999px;
				padding: 8px 12px;
				border: 1px solid var(--border);
				background: #fff;
				display: inline-flex;
				align-items: center;
				gap: 6px;
			}
			.pill.active {
				background: var(--primary-subtle);
				border-color: var(--primary);
				color: var(--primary);
			}
			.small {
				font-size: 12px;
				color: var(--muted);
			}
			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				height: 44px;
				padding: 0 16px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: #fff;
				font-weight: 600;
			}
			.btn-primary {
				background: var(--primary);
				border-color: var(--primary);
				color: #fff;
			}
			.btn:disabled {
				background: #f3f4f6;
				border-color: var(--border);
				color: #94a3b8;
			}
			.btn-small {
				height: 36px;
				padding: 0 12px;
				border-radius: 10px;
				font-size: 14px;
			}
			.capture {
				border: 1px dashed var(--border);
				border-radius: 12px;
				padding: 16px;
				text-align: center;
				background: #fff;
			}
			.thumb {
				width: 100%;
				height: 160px;
				border: 1px solid var(--border);
				border-radius: 10px;
				background: #f8fafc;
				display: flex;
				align-items: center;
				justify-content: center;
				color: #94a3b8;
				margin-top: 8px;
			}
			.bottom-affix {
				position: fixed;
				left: 0;
				right: 0;
				bottom: 0;
				background: #fff;
				border-top: 1px solid var(--border);
				padding: 12px 16px;
				display: flex;
				gap: 8px;
				z-index: 20;
			}
			.bottom-affix .btn {
				flex: 1;
			}
		</style>
	</head>
	<body>
		<div class="navbar"><div class="title">安全与 PPE 采集</div></div>
		<div class="container">
			<div class="section">
				<div class="sec-head">
					<div class="sec-title">选择今日实例（时窗）</div>
					<div class="small">用于确定证据归属</div>
				</div>
				<div id="tw" class="row" style="flex-wrap: wrap; gap: 8px"></div>
				<div class="small" id="twHint" style="margin-top: 6px; color: #475569"></div>
			</div>

			<div class="section">
				<div class="sec-head">
					<div class="sec-title">穿戴要求</div>
					<div class="small">本时窗一次采集，后续设备复用</div>
				</div>
				<ul class="small" style="margin: 0 0 8px 18px">
					<li>两人在场：执行人 + 监护人；</li>
					<li>按规范穿戴劳保用品；</li>
					<li>照片自动加水印：时间/地点/计划/人员。</li>
				</ul>
				<div class="capture">
					<div>拍摄 PPE 合影</div>
					<button id="capBtn" class="btn btn-primary" style="margin-top: 8px">拍摄</button>
					<div id="thumb" class="thumb">尚未采集</div>
				</div>
			</div>

			<div class="section" id="receipt" style="display: none">
				<div class="sec-head">
					<div class="sec-title">采集完成</div>
					<span class="small" id="rcTime"></span>
				</div>
				<div class="small">执行人：张三　监护人：李四　地点：厂区南门附近</div>
			</div>
		</div>
		<div class="bottom-affix">
			<a class="btn" href="javascript:history.back()">返回</a>
			<button id="goBtn" class="btn btn-primary" disabled>开始本时窗巡检</button>
		</div>

		<script>
			// --- Demo 数据 ---
			const TIME_WINDOWS = [
				{ key: '08:00-09:00', name: '08:00–09:00' },
				{ key: '12:00-13:00', name: '12:00–13:00' },
				{ key: '18:00-19:00', name: '18:00–19:00' },
			];
			const NOW = '11:30';
			function pickDefaultTW() {
				// 进行中 > 可开始(近似用当前/即将) > 最近未到 > 最近已完成（这里以当前时间简化）
				// 11:30 -> 12:00–13:00 为最近合理
				return '12:00-13:00';
			}

			// --- 渲染时窗 ---
			let twSelected = pickDefaultTW();
			const twEl = document.getElementById('tw');
			TIME_WINDOWS.forEach((w) => {
				const el = document.createElement('div');
				el.className = 'pill' + (w.key === twSelected ? ' active' : '');
				el.textContent = w.name;
				el.dataset.key = w.key;
				el.onclick = () => {
					twSelected = w.key;
					Array.from(twEl.children).forEach((c) => c.classList.remove('active'));
					el.classList.add('active');
				};
				twEl.appendChild(el);
			});
			const from = new URLSearchParams(location.search).get('from');
			const twParam = new URLSearchParams(location.search).get('tw');
			if (twParam) {
				twSelected = twParam;
				Array.from(twEl.children).forEach((c) => {
					c.classList.toggle('active', c.dataset.key === twSelected);
				});
			}

			document.getElementById('twHint').textContent = '当前选择：' + twSelected.replace('-', '–') + '（可切换）';

			// --- 拍摄模拟 ---
			const capBtn = document.getElementById('capBtn');
			const thumb = document.getElementById('thumb');
			const rc = document.getElementById('receipt');
			const rcTime = document.getElementById('rcTime');
			const goBtn = document.getElementById('goBtn');

			capBtn.onclick = () => {
				// 模拟拍摄成功
				const t = new Date();
				const hh = String(t.getHours()).padStart(2, '0');
				const mm = String(t.getMinutes()).padStart(2, '0');
				thumb.textContent = hh + ':' + mm + ' PPE 已采集（示意图位置信息水印）';
				thumb.style.color = '#0F172A';
				rc.style.display = '';
				rcTime.textContent = hh + ':' + mm;
				goBtn.disabled = false;
				// 存储本时窗 PPE 状态
				localStorage.setItem(
					'ppe_state',
					JSON.stringify({
						state: 'COMPLETED',
						window: twSelected,
						time: hh + ':' + mm,
						operators: '张三/李四',
					})
				);
			};

			goBtn.onclick = () => {
				// 返回来源或默认回任务列表
				if (from) {
					location.href = from;
				} else {
					location.href = 'task-list-aggregate.html';
				}
			};
		</script>
	</body>
</html>

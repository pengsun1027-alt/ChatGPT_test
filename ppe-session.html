<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>设备巡检系统 - PPE会话采集</title>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
					sans-serif;
				background: #f7f8fa;
				/* 禁用纵向滚动条但保留滚动功能 */
				overflow-y: scroll;
				/* IE/Edge 隐藏滚动条 */
				-ms-overflow-style: none;
			}
			/* Firefox 隐藏滚动条 */
			html {
				scrollbar-width: none;
			}
			/* 隐藏滚动条 */
			::-webkit-scrollbar {
				width: 0;
				background: transparent;
			}

			.safe-bottom {
				padding-bottom: max(env(safe-area-inset-bottom), 0.75rem);
			}
		</style>
	</head>
	<body>
		<!-- 顶部导航栏 -->
		<header
			class="fixed inset-x-0 top-0 h-12 bg-white/90 backdrop-blur shadow-sm flex items-center justify-between px-4 z-50"
		>
			<button class="w-8 h-8 flex items-center justify-center" onclick="history.back()">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
			</button>
			<h1 class="text-base font-semibold">安全与 PPE 采集</h1>
			<div class="w-8"></div>
		</header>

		<!-- 主要内容区域 -->
		<main class="mt-14 px-4 pb-20 space-y-4">
			<!-- 选择今日时窗 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-4">
					<h3 class="font-semibold text-slate-800">选择今日时窗</h3>
					<span class="text-xs text-slate-500">用于确定证据归属</span>
				</div>
				<div id="tw" class="flex flex-wrap gap-2 mb-3"></div>
				<div id="twHint" class="text-xs text-slate-600"></div>
			</div>

			<!-- 穿戴要求 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="flex items-center justify-between mb-4">
					<h3 class="font-semibold text-slate-800">穿戴要求</h3>
					<span class="text-xs text-slate-500">本时窗一次采集，后续设备复用</span>
				</div>

				<ul class="text-sm text-slate-600 mb-4 pl-4 space-y-1">
					<li class="flex items-start">
						<span class="w-1 h-1 bg-slate-400 rounded-full mt-2 mr-2 flex-shrink-0"></span>
						两人在场：执行人 + 监护人；
					</li>
					<li class="flex items-start">
						<span class="w-1 h-1 bg-slate-400 rounded-full mt-2 mr-2 flex-shrink-0"></span>
						按规范穿戴劳保用品；
					</li>
					<li class="flex items-start">
						<span class="w-1 h-1 bg-slate-400 rounded-full mt-2 mr-2 flex-shrink-0"></span>
						照片自动加水印：时间/地点/计划/人员。
					</li>
				</ul>

				<div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center bg-slate-50">
					<div class="mb-4">
						<svg
							class="w-8 h-8 mx-auto text-slate-400 mb-2"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
							/>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
							/>
						</svg>
						<div class="text-sm font-medium text-slate-700 mb-2">拍摄 PPE 合影</div>
						<button
							id="capBtn"
							class="px-6 py-2 text-white font-semibold rounded hover:bg-blue-700 hover:-translate-y-px transition-all duration-200"
							style="background-color: #2563eb"
						>
							拍摄
						</button>
					</div>
					<div
						id="thumb"
						class="w-full h-40 bg-white border border-slate-200 rounded-lg flex items-center justify-center text-slate-400 text-sm"
					>
						尚未采集
					</div>
				</div>
			</div>

			<!-- 采集完成状态 -->
			<div id="receipt" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
				<div class="flex items-center justify-between mb-2">
					<h3 class="font-semibold text-green-800">采集完成</h3>
					<span id="rcTime" class="text-xs text-green-600"></span>
				</div>
				<div class="text-sm text-green-700">执行人：张三　监护人：李四　地点：厂区南门附近</div>
			</div>
		</main>

		<!-- 底部操作栏 -->
		<div class="fixed inset-x-0 bottom-0 bg-white/95 backdrop-blur border-t border-slate-200 safe-bottom z-50">
			<div class="px-4 py-3 flex space-x-3">
				<button
					class="flex-1 py-3 bg-slate-100 text-slate-700 font-medium rounded hover:bg-slate-200 transition-all duration-200"
					onclick="history.back()"
				>
					返回
				</button>
				<button
					id="goBtn"
					class="flex-1 py-3 bg-slate-300 text-slate-500 font-semibold rounded transition-all duration-200"
					disabled
				>
					开始本时窗巡检
				</button>
			</div>
		</div>

		<script>
			// Demo 数据
			const TIME_WINDOWS = [
				{ key: '08:00-09:00', name: '08:00–09:00' },
				{ key: '12:00-13:00', name: '12:00–13:00' },
				{ key: '18:00-19:00', name: '18:00–19:00' },
			];
			const NOW = '11:30';

			function pickDefaultTW() {
				// 11:30 -> 12:00–13:00 为最近合理
				return '12:00-13:00';
			}

			// 渲染时窗
			let twSelected = pickDefaultTW();
			const twEl = document.getElementById('tw');
			TIME_WINDOWS.forEach((w) => {
				const el = document.createElement('button');
				el.className =
					w.key === twSelected
						? 'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-200 cursor-pointer active'
						: 'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 cursor-pointer';
				el.textContent = w.name;
				el.dataset.key = w.key;
				el.onclick = () => {
					twSelected = w.key;
					Array.from(twEl.children).forEach((c) => {
						c.className =
							'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 cursor-pointer';
					});
					el.className =
						'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-200 cursor-pointer active';
					document.getElementById('twHint').textContent =
						'当前选择：' + twSelected.replace('-', '–') + '（可切换）';
				};
				twEl.appendChild(el);
			});

			// 处理URL参数
			const from = new URLSearchParams(location.search).get('from');
			const twParam = new URLSearchParams(location.search).get('tw');
			if (twParam) {
				twSelected = twParam;
				Array.from(twEl.children).forEach((c) => {
					if (c.dataset.key === twSelected) {
						c.className =
							'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-200 cursor-pointer active';
					} else {
						c.className =
							'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 cursor-pointer';
					}
				});
			}

			document.getElementById('twHint').textContent = '当前选择：' + twSelected.replace('-', '–') + '（可切换）';

			// 拍摄模拟
			const capBtn = document.getElementById('capBtn');
			const thumb = document.getElementById('thumb');
			const rc = document.getElementById('receipt');
			const rcTime = document.getElementById('rcTime');
			const goBtn = document.getElementById('goBtn');

			capBtn.onclick = () => {
				// 模拟拍摄成功
				const t = new Date();
				const hh = String(t.getHours()).padStart(2, '0');
				const mm = String(t.getMinutes()).padStart(2, '0');

				thumb.textContent = hh + ':' + mm + ' PPE 已采集（示意图位置信息水印）';
				thumb.className =
					'w-full h-40 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center text-green-700 text-sm font-medium';

				rc.classList.remove('hidden');
				rcTime.textContent = hh + ':' + mm;
				goBtn.disabled = false;
				goBtn.className =
					'flex-1 py-3 text-white font-semibold rounded hover:bg-blue-700 hover:-translate-y-px transition-all duration-200';
				goBtn.style.backgroundColor = '#2563EB';

				// 存储本时窗 PPE 状态
				localStorage.setItem(
					'ppe_state',
					JSON.stringify({
						state: 'COMPLETED',
						window: twSelected,
						time: hh + ':' + mm,
						operators: '张三/李四',
					})
				);
			};

			goBtn.onclick = () => {
				// 返回来源或默认回任务列表
				if (from) {
					location.href = from;
				} else {
					location.href = 'task-list-aggregate.html';
				}
			};
		</script>
	</body>
</html>

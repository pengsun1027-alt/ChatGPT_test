<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>巡检任务 · 聚合（含 PPE 状态）</title>
		<link rel="stylesheet" href="styles.css">
                <style>
			:root {
				--primary: #2b6fff;
				--primary-active: #1c54f0;
				--primary-subtle: #e8eeff;
				--success: #22c55e;
				--warning: #f59e0b;
				--danger: #ef4444;
				--text: #0f172a;
				--muted: #64748b;
				--border: #e2e8f0;
				--bg: #f8fafc;
				--card: #ffffff;
				--shadow: 0 6px 16px rgba(16, 24, 40, 0.06);
			}
			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}
			body {
				margin: 0;
				padding: 0;
				background: var(--bg);
				color: var(--text);
				font-family: var(--font-family);
				font-size: var(--font-size);
				line-height: var(--line-height);
				/* 禁用纵向滚动条但保留滚动功能 */
				overflow-y: scroll;
			}
			/* Firefox 隐藏滚动条 */
			html {
				scrollbar-width: none;
			}

			/* 隐藏滚动条 */
			::-webkit-scrollbar {
				width: 0;
				background: transparent;
			}

			/* IE/Edge 隐藏滚动条 */
			-ms-overflow-style: none;
			a {
				color: inherit;
				text-decoration: none;
			}
			.container {
				padding: var(--spacing);
			}
			.navbar {
				position: sticky;
				top: 0;
				z-index: 10;
				background: #fff;
				padding: calc(var(--spacing) * 0.75) 16px;
				border-bottom: 1px solid var(--border);
				display: flex;
				align-items: center;
				gap: calc(var(--spacing) * 0.75);
			}
			.navbar .title {
				font-weight: 600;
				font-size: 18px;
			}
			.search {
				margin-left: auto;
				display: flex;
				align-items: center;
				gap: calc(var(--spacing) * 0.5);
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 0 12px;
				background: #fff;
				height: 44px;
			}
			.search input {
				border: none;
				outline: none;
				flex: 1;
				height: 42px;
				font-size: 14px;
			}
			.ppe-bar {
				position: sticky;
				top: 54px;
				z-index: 9;
				background: #fff;
				border-bottom: 1px solid var(--border);
				padding: 10px 16px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: calc(var(--spacing) * 0.5);
			}
			.ppe-bar .state {
				display: flex;
				gap: calc(var(--spacing) * 0.5);
				align-items: center;
				font-weight: 600;
			}
			.ppe-bar .dot {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				background: #ef4444;
			}
			.ppe-bar.done .dot {
				background: #22c55e;
			}
			.ppe-bar.expired .dot {
				background: #f59e0b;
			}
			.ppe-bar .small {
				font-size: 12px;
				color: var(--muted);
			}
			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				height: 36px;
				padding: 0 12px;
				border-radius: 10px;
				border: 1px solid var(--border);
				background: #fff;
				font-weight: 600;
			}
			.btn-primary {
				background: var(--primary);
				border-color: var(--primary);
				color: #fff;
			}
			.filter-bar {
				position: sticky;
				top: 104px;
				background: #fff;
				z-index: 8;
				border-bottom: 1px solid var(--border);
				padding: calc(var(--spacing) * 0.5) 16px;
				display: flex;
				gap: calc(var(--spacing) * 0.5);
				align-items: center;
				overflow: auto;
			}
			.chip {
				padding: calc(var(--spacing) * 0.5) 12px;
				border: 1px solid var(--border);
				border-radius: 999px;
				background: #fff;
				font-size: 14px;
				white-space: nowrap;
			}
			.chip.active {
				background: var(--primary-subtle);
				border-color: var(--primary);
				color: var(--primary);
			}
			.card {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 12px;
				box-shadow: var(--shadow);
			}
			.card + .card {
				margin-top: calc(var(--spacing) * 0.75);
			}
			.device-card {
				padding: calc(var(--spacing) * 0.75);
			}
			.device-card .head {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			.device-card .title {
				font-weight: 700;
				font-size: var(--font-size);
			}
			.device-card .meta {
				font-size: 12px;
				color: var(--muted);
			}
			.pills {
				display: flex;
				gap: 6px;
				flex-wrap: wrap;
			}
			.pill {
				font-size: 12px;
				border-radius: 999px;
				padding: 4px 8px;
				border: 1px solid var(--border);
				background: #fff;
				display: inline-flex;
				align-items: center;
				gap: 6px;
			}
			.pill .dot {
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background: #94a3b8;
			}
			.pill.blue .dot {
				background: #2b6fff;
			}
			.pill.red .dot {
				background: #ef4444;
			}
			.pill.green .dot {
				background: #22c55e;
			}
			.pill.gray .dot {
				background: #94a3b8;
			}
			.task-row {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 10px 0;
				border-top: 1px dashed var(--border);
			}
			.task-row:first-child {
				border-top: none;
			}
			.small {
				font-size: 12px;
				color: var(--muted);
			}
			.footer {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: calc(var(--spacing) * 0.75);
			}
			.more {
				position: relative;
			}
			.more-menu {
				display: none;
				position: absolute;
				left: 0;
				bottom: 40px;
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 12px;
				box-shadow: var(--shadow);
				padding: calc(var(--spacing) * 0.5);
				min-width: 160px;
			}
			.more-menu a {
				display: block;
				padding: calc(var(--spacing) * 0.5) 10px;
				border-radius: 8px;
			}
			.more.open .more-menu {
				display: block;
			}
			.btn-small {
				height: 32px;
				padding: 0 12px;
				border-radius: 10px;
				font-size: 14px;
			}
		</style>
	</head>
	<body>
		<div class="navbar">
			<div class="title">巡检任务 · 聚合</div>
			<div class="search"><input placeholder="搜索设备/项目" /></div>
		</div>

		<!-- PPE 会话状态条（显式入口） -->
		<div id="ppeBar" class="ppe-bar">
			<div class="state">
				<div class="dot"></div>
				<div id="ppeText">本时窗 PPE：未完成</div>
			</div>
			<div style="display: flex; gap: calc(var(--spacing) * 0.5); align-items: center">
				<span id="ppeMeta" class="small"></span>
				<a id="ppeBtn" class="btn btn-primary" href="ppe-session.html?from=task-list-aggregate.html">去采集</a>
			</div>
		</div>

		<div class="filter-bar">
			<div class="chip active">全部</div>
			<div class="chip">可开始</div>
			<div class="chip">进行中</div>
			<div class="chip">逾期</div>
		</div>

		<div class="container">
			<!-- 单个设备聚合卡（示例） -->
			<div class="card device-card" id="card">
				<div class="head">
					<div>
						<div class="title"><span id="devName"></span> <span class="small" id="devId"></span></div>
						<div class="meta" id="devSite"></div>
					</div>
					<div class="pills" id="stat"></div>
				</div>

				<div id="rows"></div>
				<div class="small" style="margin-top: calc(var(--spacing) * 0.5)"><a href="#" id="toggleMore">查看更多</a></div>

				<div class="footer">
					<!-- 左下角：更多 -->
					<div class="more" id="more">
						<button
							class="btn btn-small"
							onclick="document.getElementById('more').classList.toggle('open')"
						>
							更多
						</button>
						<div class="more-menu">
							<a href="#" class="need-ppe" data-action="scan">扫码到点</a>
							<a href="#" onclick="alert('新建报修单');">异常报修</a>
							<a href="#" onclick="showUnavail()">设备无法巡检</a>
						</div>
					</div>
					<!-- 右侧主操作 -->
					<div style="display: flex; gap: calc(var(--spacing) * 0.5)">
						<a class="btn need-ppe" data-action="detail" href="task-detail_mixed.html">任务详情</a>
						<a id="claimBtn" class="btn btn-primary need-ppe" data-action="claim" href="#"
							>本设备全部领取</a
						>
					</div>
				</div>

				<div class="small" style="margin-top: calc(var(--spacing) * 0.5); color: var(--muted)">
					说明：默认仅展示 3
					条；未到时间标为「未到时间」，可查看不可开始；“更多”在左下角；主操作“全部领取”靠右，便于右手操作。
				</div>
			</div>
		</div>

		<!-- 设备无法巡检弹窗 -->
		<div
			id="unavail-modal"
			class="modal-backdrop"
			style="
				position: fixed;
				inset: 0;
				background: rgba(15, 23, 42, 0.45);
				display: none;
				align-items: flex-end;
				z-index: 99;
			"
		>
			<div
				class="modal"
				style="
					width: 100%;
					background: #fff;
					border-top-left-radius: 16px;
					border-top-right-radius: 16px;
					padding: var(--spacing);
					border: 1px solid var(--border);
				"
			>
				<h3 style="margin: 0 0 8px 0; font-size: 16px">设备无法巡检</h3>
				<div class="row" style="display: flex; gap: calc(var(--spacing) * 0.5); margin: 8px 0; flex-wrap: wrap">
					<div class="chip">停电/断电</div>
					<div class="chip">设备检修中</div>
					<div class="chip">安全风险</div>
					<div class="chip">无权限进入</div>
					<div class="chip">其他</div>
				</div>
				<textarea
					id="unavail-reason"
					style="
						width: 100%;
						min-height: 80px;
						border: 1px solid var(--border);
						border-radius: 10px;
						padding: calc(var(--spacing) * 0.5);
					"
					placeholder="请补充具体原因（必填）"
				></textarea>
				<div class="row" style="display: flex; gap: calc(var(--spacing) * 0.5); margin-top: calc(var(--spacing) * 0.75)">
					<button class="btn" onclick="hideUnavail()">取消</button>
					<button class="btn btn-primary" onclick="saveUnavail()">提交</button>
				</div>
			</div>
		</div>

		<script>
			// ===== PPE 状态读取与显隐 =====
			function readPPE() {
				try {
					return JSON.parse(localStorage.getItem('ppe_state') || 'null');
				} catch (e) {
					return null;
				}
			}
			function cmp(a, b) {
				return a.localeCompare(b);
			}
			const TIME_WINDOWS = [
				{ key: '08:00-09:00', start: '08:00', end: '09:00' },
				{ key: '12:00-13:00', start: '12:00', end: '13:00' },
				{ key: '18:00-19:00', start: '18:00', end: '19:00' },
			];
			const NOW = '11:30';
			function pickWindow() {
				// 进行中 > 即将开始 > 最近未到 > 最近已完成
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) >= 0 && cmp(NOW, w.end) <= 0) return w;
				}
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) < 0) return w;
				}
				return TIME_WINDOWS[TIME_WINDOWS.length - 1];
			}
			const curW = pickWindow();
			const ppe = readPPE();
			const ppeBar = document.getElementById('ppeBar');
			const ppeText = document.getElementById('ppeText');
			const ppeMeta = document.getElementById('ppeMeta');
			const ppeBtn = document.getElementById('ppeBtn');
			function isExpired() {
				if (!ppe || ppe.state !== 'COMPLETED') return false;
				const w = TIME_WINDOWS.find((x) => x.key === ppe.window);
				if (!w) return true;
				return cmp(NOW, w.end) > 0 && curW.key !== ppe.window; // 简化过期逻辑
			}
			if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) {
				ppeBar.classList.add('done');
				ppeText.textContent = '本时窗 PPE：已完成';
				ppeMeta.textContent = ppe.time + ' · ' + (ppe.operators || '');
				ppeBtn.textContent = '查看留痕';
				ppeBtn.href = '#';
				ppeBtn.onclick = function (e) {
					e.preventDefault();
					alert('PPE 留痕：' + ppe.time + ' ' + (ppe.operators || ''));
				};
			} else if (ppe && isExpired()) {
				ppeBar.classList.add('expired');
				ppeText.textContent = '本时窗 PPE：已过期';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '重新采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-aggregate.html&tw=' + encodeURIComponent(curW.key);
			} else {
				ppeText.textContent = '本时窗 PPE：未完成';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '去采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-aggregate.html&tw=' + encodeURIComponent(curW.key);
			}

			// ===== 示例设备数据 =====
			const dev = { id: 'DEV-001', name: '供水泵#1', site: '一号厂 · 南区' };
			document.getElementById('devName').textContent = dev.name;
			document.getElementById('devId').textContent = '（' + dev.id + '）';
			document.getElementById('devSite').textContent = dev.site;

			const PROJECTS = [
				{ id: 'TEMP', name: '电机温度' },
				{ id: 'AMP', name: '运行电流' },
				{ id: 'VIB', name: '轴承振动' },
			];
			const rows = [];
			TIME_WINDOWS.forEach((w) => PROJECTS.forEach((p) => rows.push({ w, p, state: 'UNSTARTED' })));
			rows.forEach((r) => {
				if (cmp(NOW, r.w.start) < 0) r.state = 'NOT_YET';
				else if (cmp(NOW, r.w.end) > 0) r.state = 'OVERDUE';
				else r.state = Math.random() < 0.3 ? 'IN_PROGRESS' : 'OPEN';
			});

			function pill(s) {
				const map = {
					NOT_YET: '未到时间',
					UNSTARTED: '待领',
					OPEN: '可开始',
					IN_PROGRESS: '进行中',
					OVERDUE: '逾期',
					DONE: '已完成',
				};
				const cls =
					{
						NOT_YET: 'gray',
						UNSTARTED: 'gray',
						OPEN: 'blue',
						IN_PROGRESS: 'blue',
						OVERDUE: 'red',
						DONE: 'green',
					}[s] || 'gray';
				return '<span class="pill ' + cls + '"><span class="dot"></span> ' + map[s] + '</span>';
			}
			function rowCtaLabel(s) {
				return s === 'NOT_YET' || s === 'DONE' ? '查看' : '进入';
			}

			const statEl = document.getElementById('stat');
			const sNotYet = rows.filter((x) => x.state === 'NOT_YET').length;
			const sOpen = rows.filter((x) => x.state === 'OPEN' || x.state === 'IN_PROGRESS').length;
			const sOver = rows.filter((x) => x.state === 'OVERDUE').length;
			statEl.innerHTML =
				'<span class="pill gray"><span class="dot"></span> 未到 ' +
				sNotYet +
				'</span>' +
				'<span class="pill blue"><span class="dot"></span> 在办 ' +
				sOpen +
				'</span>' +
				(sOver ? '<span class="pill red"><span class="dot"></span> 逾期 ' + sOver + '</span>' : '');

			const list = document.getElementById('rows');
			const sorted = rows.slice().sort((a, b) => a.w.start.localeCompare(b.w.start));
			let showAll = false;
			function render() {
				list.innerHTML = '';
				const toShow = showAll ? sorted : sorted.slice(0, 3);
				toShow.forEach((r) => {
					const row = document.createElement('div');
					row.className = 'task-row';
					const disabled = r.state === 'NOT_YET' || r.state === 'DONE';
					row.innerHTML =
						'<div>' +
						r.p.name +
						' <span class="small">· ' +
						r.w.start +
						'–' +
						r.w.end +
						'</span></div>' +
						'<div style="display:flex;gap:8px;align-items:center;">' +
						pill(r.state) +
						'<a class="btn btn-small ' +
						(disabled ? '' : 'btn-primary') +
						' need-ppe" data-action="row" href="' +
						(disabled ? 'task-detail_all-notyet.html' : 'task-detail_mixed.html') +
						'" ' +
						(disabled ? '' : 'style="color:#fff"') +
						'>' +
						rowCtaLabel(r.state) +
						'</a></div>';
					list.appendChild(row);
				});
				document.getElementById('toggleMore').textContent = showAll ? '收起' : '查看更多';
			}
			document.getElementById('toggleMore').addEventListener('click', (e) => {
				e.preventDefault();
				showAll = !showAll;
				render();
			});
			render();

			function claimAll() {
				const claimables = rows.filter(
					(x) => x.state === 'OPEN' || x.state === 'IN_PROGRESS' || x.state === 'OVERDUE'
				);
				alert('已领取 ' + claimables.length + ' 条（仅可开始/进行中/逾期）');
			}

			// 拦截：PPE 未完成时跳转采集页
			function ppeGuard(e) {
				const action = e.currentTarget.dataset.action || 'click';
				if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) return true;
				e.preventDefault();
				const url =
					'ppe-session.html?from=' +
					encodeURIComponent('task-list-aggregate.html') +
					'&tw=' +
					encodeURIComponent(curW.key);
				location.href = url;
				return false;
			}
			Array.from(document.querySelectorAll('.need-ppe')).forEach((el) => {
				el.addEventListener('click', ppeGuard);
			});

			document.getElementById('claimBtn').addEventListener('click', function (e) {
				if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) {
					e.preventDefault();
					claimAll();
				}
			});

			// modal handlers
			function showUnavail() {
				document.getElementById('unavail-modal').style.display = 'flex';
			}
			function hideUnavail() {
				document.getElementById('unavail-modal').style.display = 'none';
			}
			function saveUnavail() {
				const t = document.getElementById('unavail-reason').value.trim();
				if (!t) {
					alert('请填写原因');
					return;
				}
				alert('已记录设备无法巡检原因：' + t);
				hideUnavail();
			}
		</script>
	</body>
</html>

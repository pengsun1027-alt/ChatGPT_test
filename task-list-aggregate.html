<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>设备巡检系统 - 聚合任务</title>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
					sans-serif;
				background: #f7f8fa;
			}
		</style>
	</head>
	<body>
		<!-- 顶部导航栏 -->
		<header
			class="fixed inset-x-0 top-0 h-12 bg-white/90 backdrop-blur shadow-sm flex items-center justify-between px-4 z-50"
		>
			<button class="w-8 h-8 flex items-center justify-center" onclick="history.back()">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
			</button>
			<h1 class="text-base font-semibold">聚合任务</h1>
			<button class="w-8 h-8 flex items-center justify-center">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
					/>
				</svg>
			</button>
		</header>

		<!-- PPE 状态栏 -->
		<div id="ppeBar" class="fixed inset-x-0 top-12 bg-white border-b border-slate-200 z-40">
			<div class="flex items-center justify-between px-4 py-3">
				<div class="flex items-center space-x-3">
					<div id="ppeDot" class="w-2 h-2 bg-red-500 rounded-full"></div>
					<div>
						<div id="ppeText" class="text-sm font-medium text-slate-800">本时窗 PPE：未完成</div>
						<div id="ppeMeta" class="text-xs text-slate-500"></div>
					</div>
				</div>
				<a
					id="ppeBtn"
					class="px-3 py-1 text-white text-sm font-medium rounded hover:bg-blue-700"
					style="background-color: #2563eb"
					href="ppe-session.html?from=task-list-aggregate.html"
				>
					去采集
				</a>
			</div>
		</div>

		<!-- 筛选栏（轻盈风格） -->
		<div class="fixed inset-x-0 top-28 bg-white/90 backdrop-blur shadow-sm z-30">
			<div class="flex space-x-1 px-4 py-3 overflow-x-auto">
				<button
					class="px-4 py-2 text-sm font-semibold rounded-full text-white whitespace-nowrap"
					style="background-color: #2563eb"
				>
					全部
				</button>
				<button
					class="px-4 py-2 text-sm font-semibold rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					可开始
				</button>
				<button
					class="px-4 py-2 text-sm font-semibold rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					进行中
				</button>
				<button
					class="px-4 py-2 text-sm font-semibold rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					逾期
				</button>
			</div>
		</div>

		<!-- 主要内容区域 -->
		<main class="mt-44 px-4 pb-6 space-y-4">
			<!-- 设备聚合卡片 -->
			<div class="bg-white rounded-lg shadow-sm p-4">
				<div class="mb-4">
					<!-- 设备名称与编号一行 -->
					<div class="flex items-center space-x-2 mb-2">
						<h3 id="devName" class="text-lg font-bold text-slate-800">供水泵#1</h3>
						<span id="devId" class="text-sm text-slate-500">(DEV-001)</span>
					</div>
					<!-- 地点与状态标签一行 -->
					<div class="flex items-center justify-between">
						<div id="devSite" class="text-sm text-slate-600">一号厂 · 南区</div>
						<div id="stat" class="flex flex-wrap gap-1"></div>
					</div>
				</div>

				<!-- 卡片头与内容分隔线 -->
				<hr class="border-slate-300 my-4">

				<div id="rows" class="space-y-0"></div>

				<div class="mt-3">
					<button
						id="toggleMore"
						class="w-full py-2.5 text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 rounded font-medium"
					>
						查看更多
					</button>
				</div>

				<div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
					<div class="relative">
						<button
							id="moreBtn"
							class="px-3 py-2 bg-slate-100 text-slate-700 text-sm font-medium rounded hover:bg-slate-200"
							onclick="toggleMore()"
						>
							更多
						</button>
						<div
							id="moreMenu"
							class="hidden absolute left-0 bottom-full mb-2 w-40 bg-white rounded-lg shadow-lg border border-slate-200 py-2 z-50"
						>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 need-ppe"
								data-action="scan"
								>扫码到点</a
							>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50"
								onclick="alert('异常报修：带入设备上下文');"
								>异常报修</a
							>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50"
								onclick="showUnavail()"
								>设备无法巡检</a
							>
						</div>
					</div>
					<div class="flex space-x-2">
						<a
							class="px-4 py-2 bg-slate-100 text-slate-700 text-sm font-medium rounded hover:bg-slate-200 need-ppe"
							data-action="detail"
							href="task-detail_mixed.html"
						>
							任务详情
						</a>
						<button
							id="claimBtn"
							class="px-4 py-2 text-white text-sm font-medium rounded hover:bg-blue-700 need-ppe"
							style="background-color: #2563eb"
							data-action="claim"
						>
							本设备全部领取
						</button>
					</div>
				</div>

			<!-- 信息提示样式 -->
			<div class="mt-3 p-3 bg-slate-50 rounded flex items-start gap-2 text-xs text-slate-600">
				<svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M11 11v6m0-8h.01M12 4.5a7.5 7.5 0 100 15 7.5 7.5 0 000-15z"/>
				</svg>
				<div>
					<div>默认仅展示 3 条，点击「查看更多」可展开全部任务。</div>
					<div>处于「未到时间」的任务仅可查看不可进入；</div>
					<div>进入任务前需完成当时窗 PPE 采集；</div>
				</div>
			</div>
		</main>

		<!-- 底部弹窗 - 设备无法巡检 -->
		<div id="unavail-modal" class="fixed inset-0 bg-black/50 hidden items-end z-50">
			<div class="bg-white rounded-t-2xl w-full p-6">
				<h3 class="text-lg font-semibold mb-4">设备无法巡检</h3>
				<div class="flex flex-wrap gap-2 mb-4">
					<button class="px-3 py-1 border border-slate-300 rounded-full text-sm hover:bg-slate-50">
						停电/断电
					</button>
					<button class="px-3 py-1 border border-slate-300 rounded-full text-sm hover:bg-slate-50">
						设备检修中
					</button>
					<button class="px-3 py-1 border border-slate-300 rounded-full text-sm hover:bg-slate-50">
						安全风险
					</button>
					<button class="px-3 py-1 border border-slate-300 rounded-full text-sm hover:bg-slate-50">
						无权限进入
					</button>
					<button class="px-3 py-1 border border-slate-300 rounded-full text-sm hover:bg-slate-50">
						其他
					</button>
				</div>
				<textarea
					id="unavail-reason"
					class="w-full min-h-20 border border-slate-300 rounded-lg p-3 text-sm resize-none"
					placeholder="请补充具体原因（必填）"
				></textarea>
				<div class="flex space-x-3 mt-4">
					<button
						class="flex-1 py-3 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200"
						onclick="hideUnavail()"
					>
						取消
					</button>
					<button
						class="flex-1 py-3 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600"
						onclick="saveUnavail()"
					>
						提交
					</button>
				</div>
			</div>
		</div>

		<script>
			// PPE 状态读取与显隐
			function readPPE() {
				try {
					return JSON.parse(localStorage.getItem('ppe_state') || 'null');
				} catch (e) {
					return null;
				}
			}

			function cmp(a, b) {
				return a.localeCompare(b);
			}

			const TIME_WINDOWS = [
				{ key: '08:00-09:00', start: '08:00', end: '09:00' },
				{ key: '12:00-13:00', start: '12:00', end: '13:00' },
				{ key: '18:00-19:00', start: '18:00', end: '19:00' },
			];

			const NOW = '11:30';

			function pickWindow() {
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) >= 0 && cmp(NOW, w.end) <= 0) return w;
				}
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) < 0) return w;
				}
				return TIME_WINDOWS[TIME_WINDOWS.length - 1];
			}

			const curW = pickWindow();
			const ppe = readPPE();
			const ppeDot = document.getElementById('ppeDot');
			const ppeText = document.getElementById('ppeText');
			const ppeMeta = document.getElementById('ppeMeta');
			const ppeBtn = document.getElementById('ppeBtn');

			function isExpired() {
				if (!ppe || ppe.state !== 'COMPLETED') return false;
				const w = TIME_WINDOWS.find((x) => x.key === ppe.window);
				if (!w) return true;
				return cmp(NOW, w.end) > 0 && curW.key !== ppe.window;
			}

			if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) {
				ppeDot.className = 'w-2 h-2 bg-green-500 rounded-full';
				ppeText.textContent = '本时窗 PPE：已完成';
				ppeMeta.textContent = ppe.time + ' · ' + (ppe.operators || '');
				ppeBtn.textContent = '查看留痕';
				ppeBtn.href = '#';
				ppeBtn.onclick = function (e) {
					e.preventDefault();
					alert('PPE 留痕：' + ppe.time + ' ' + (ppe.operators || ''));
				};
			} else if (ppe && isExpired()) {
				ppeDot.className = 'w-2 h-2 bg-orange-500 rounded-full';
				ppeText.textContent = '本时窗 PPE：已过期';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '重新采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-aggregate.html&tw=' + encodeURIComponent(curW.key);
			} else {
				ppeText.textContent = '本时窗 PPE：未完成';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '去采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-aggregate.html&tw=' + encodeURIComponent(curW.key);
			}

			// 示例设备数据
			const dev = { id: 'DEV-001', name: '供水泵#1', site: '一号厂 · 南区' };
			document.getElementById('devName').textContent = dev.name;
			document.getElementById('devId').textContent = '(' + dev.id + ')';
			document.getElementById('devSite').textContent = dev.site;

			const PROJECTS = [
				{ id: 'TEMP', name: '电机温度' },
				{ id: 'AMP', name: '运行电流' },
				{ id: 'VIB', name: '轴承振动' },
			];

			const rows = [];
			TIME_WINDOWS.forEach((w) => PROJECTS.forEach((p) => rows.push({ w, p, state: 'UNSTARTED' })));
			rows.forEach((r) => {
				if (cmp(NOW, r.w.start) < 0) r.state = 'NOT_YET';
				else if (cmp(NOW, r.w.end) > 0) r.state = 'OVERDUE';
				else r.state = Math.random() < 0.3 ? 'IN_PROGRESS' : 'OPEN';
			});

			function getStatusBadge(state) {
				const statusMap = {
					NOT_YET: { text: '未到时间', color: 'bg-slate-100 text-slate-600' },
					UNSTARTED: { text: '待领', color: 'bg-slate-100 text-slate-600' },
					OPEN: { text: '可开始', color: 'bg-blue-100 text-blue-700' },
					IN_PROGRESS: { text: '进行中', color: 'bg-green-100 text-green-700' },
					OVERDUE: { text: '逾期', color: 'bg-red-100 text-red-700' },
					DONE: { text: '已完成', color: 'bg-green-100 text-green-700' },
				};
				const status = statusMap[state] || statusMap.UNSTARTED;
				return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status.color}"><span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>${status.text}</span>`;
			}

			function getActionButton(state) {
				const disabled = state === 'NOT_YET' || state === 'DONE';
				const buttonText = disabled ? '查看' : '进入';
				const buttonClass = disabled
					? 'px-3 py-1 bg-slate-100 text-slate-700 text-xs font-medium rounded hover:bg-slate-200'
					: 'px-3 py-1 text-white text-xs font-medium rounded hover:bg-blue-700';
				const buttonStyle = disabled ? '' : ' style="background-color: #2563EB;"';
				const href = disabled ? 'task-detail_all-notyet.html' : 'task-detail_mixed.html';
				return `<a class="${buttonClass} need-ppe" href="${href}"${buttonStyle}>${buttonText}</a>`;
			}

			// 更新统计数据
			const statEl = document.getElementById('stat');
			const sNotYet = rows.filter((x) => x.state === 'NOT_YET').length;
			const sOpen = rows.filter((x) => x.state === 'OPEN' || x.state === 'IN_PROGRESS').length;
			const sOver = rows.filter((x) => x.state === 'OVERDUE').length;

			let statHtml = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600"><span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>未到 ${sNotYet}</span>`;
			statHtml += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700"><span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>在办 ${sOpen}</span>`;
			if (sOver > 0) {
				statHtml += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700"><span class="w-1.5 h-1.5 bg-current rounded-full mr-1.5"></span>逾期 ${sOver}</span>`;
			}
			statEl.innerHTML = statHtml;

			// 渲染任务行
			const list = document.getElementById('rows');
			const sorted = rows.slice().sort((a, b) => a.w.start.localeCompare(b.w.start));
			let showAll = false;

			function render() {
				list.innerHTML = '';
				const toShow = showAll ? sorted : sorted.slice(0, 3);

				toShow.forEach((r) => {
					const row = document.createElement('div');
					row.className = 'flex items-center justify-between p-3 border-b border-dashed border-slate-200 last:border-b-0';
					row.innerHTML = `
						<div class="flex-1 min-w-0">
							<div class="text-base font-medium text-slate-900">${r.p.name}</div>
							<div class="text-xs text-slate-600 mt-1">${r.w.start}–${r.w.end}</div>
						</div>
						<div class="flex items-center space-x-3 ml-3">
							${getStatusBadge(r.state)}
							${getActionButton(r.state)}
						</div>
					`;
					list.appendChild(row);
				});

				const remaining = sorted.length - 3;
				document.getElementById('toggleMore').textContent = showAll ? '收起' : `查看更多 (还有${remaining}条)`;
			}

			document.getElementById('toggleMore').addEventListener('click', (e) => {
				e.preventDefault();
				showAll = !showAll;
				render();
			});

			render();

			function claimAll() {
				const claimables = rows.filter(
					(x) => x.state === 'OPEN' || x.state === 'IN_PROGRESS' || x.state === 'OVERDUE'
				);
				alert('已领取 ' + claimables.length + ' 条（仅可开始/进行中/逾期）');
			}

			// PPE拦截
			function ppeGuard(e) {
				if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) return true;
				e.preventDefault();
				const url =
					'ppe-session.html?from=' +
					encodeURIComponent('task-list-aggregate.html') +
					'&tw=' +
					encodeURIComponent(curW.key);
				location.href = url;
				return false;
			}

			Array.from(document.querySelectorAll('.need-ppe')).forEach((el) => {
				el.addEventListener('click', ppeGuard);
			});

			document.getElementById('claimBtn').addEventListener('click', function (e) {
				if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) {
					e.preventDefault();
					claimAll();
				}
			});

			// 更多菜单
			function toggleMore() {
				const menu = document.getElementById('moreMenu');
				menu.classList.toggle('hidden');
			}

			// 点击外部关闭菜单
			document.addEventListener('click', function (e) {
				const moreBtn = document.getElementById('moreBtn');
				const moreMenu = document.getElementById('moreMenu');
				if (!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) {
					moreMenu.classList.add('hidden');
				}
			});

			// 弹窗处理
			function showUnavail() {
				document.getElementById('unavail-modal').classList.remove('hidden');
				document.getElementById('unavail-modal').classList.add('flex');
				document.getElementById('moreMenu').classList.add('hidden');
			}

			function hideUnavail() {
				document.getElementById('unavail-modal').classList.add('hidden');
				document.getElementById('unavail-modal').classList.remove('flex');
			}

			function saveUnavail() {
				const t = document.getElementById('unavail-reason').value.trim();
				if (!t) {
					alert('请填写原因');
					return;
				}
				alert('已记录设备无法巡检原因：' + t);
				hideUnavail();
				document.getElementById('unavail-reason').value = '';
			}
		</script>
	</body>
</html>

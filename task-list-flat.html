<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>设备巡检系统 - 巡检任务</title>

		<!-- Vant 4 CSS -->
		<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" />
		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
					sans-serif;
				background: #f7f8fa;
			}
			.safe-bottom {
				padding-bottom: max(env(safe-area-inset-bottom), 0.75rem);
			}
		</style>
	</head>
	<body>
		<!-- 顶部导航栏 -->
		<header
			class="fixed inset-x-0 top-0 h-12 bg-white/90 backdrop-blur shadow-sm flex items-center justify-between px-4 z-50"
		>
			<button class="w-8 h-8 flex items-center justify-center" onclick="history.back()">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
			</button>
			<h1 class="text-base font-semibold">巡检任务</h1>
			<button class="w-8 h-8 flex items-center justify-center">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
					/>
				</svg>
			</button>
		</header>

		<!-- PPE 状态栏 -->
		<div id="ppeBar" class="fixed inset-x-0 top-12 bg-white border-b border-slate-200 z-40">
			<div class="flex items-center justify-between px-4 py-3">
				<div class="flex items-center space-x-3">
					<div id="ppeDot" class="w-2 h-2 bg-red-500 rounded-full"></div>
					<div>
						<div id="ppeText" class="text-sm font-medium text-slate-800">本时窗 PPE：未完成</div>
						<div id="ppeMeta" class="text-xs text-slate-500"></div>
					</div>
				</div>
				<a
					id="ppeBtn"
					class="px-3 py-1 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600"
					href="ppe-session.html?from=task-list-flat.html"
				>
					去采集
				</a>
			</div>
		</div>

		<!-- 筛选栏 -->
		<div class="fixed inset-x-0 top-28 bg-white border-b border-slate-200 z-30">
			<div class="flex space-x-1 px-4 py-3 overflow-x-auto">
				<button class="px-4 py-2 text-sm font-medium rounded-full bg-blue-500 text-white whitespace-nowrap">
					全部
				</button>
				<button
					class="px-4 py-2 text-sm font-medium rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					可开始
				</button>
				<button
					class="px-4 py-2 text-sm font-medium rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					进行中
				</button>
				<button
					class="px-4 py-2 text-sm font-medium rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 whitespace-nowrap"
				>
					逾期
				</button>
			</div>
		</div>

		<!-- 主要内容区域 -->
		<main class="mt-44 px-4 pb-6 space-y-3" id="list"></main>

		<!-- Vant 4 JS -->
		<script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>

		<script>
			// ===== PPE 状态读取与显隐 =====
			function readPPE() {
				try {
					return JSON.parse(localStorage.getItem('ppe_state') || 'null');
				} catch (e) {
					return null;
				}
			}
			function cmp(a, b) {
				return a.localeCompare(b);
			}
			const TIME_WINDOWS = [
				{ key: '08:00-09:00', start: '08:00', end: '09:00' },
				{ key: '12:00-13:00', start: '12:00', end: '13:00' },
				{ key: '18:00-19:00', start: '18:00', end: '19:00' },
			];
			const NOW = '11:30';
			function pickWindow() {
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) >= 0 && cmp(NOW, w.end) <= 0) return w;
				}
				for (const w of TIME_WINDOWS) {
					if (cmp(NOW, w.start) < 0) return w;
				}
				return TIME_WINDOWS[TIME_WINDOWS.length - 1];
			}
			const curW = pickWindow();
			const ppe = readPPE();
			const ppeDot = document.getElementById('ppeDot');
			const ppeText = document.getElementById('ppeText');
			const ppeMeta = document.getElementById('ppeMeta');
			const ppeBtn = document.getElementById('ppeBtn');
			function isExpired() {
				if (!ppe || ppe.state !== 'COMPLETED') return false;
				const w = TIME_WINDOWS.find((x) => x.key === ppe.window);
				if (!w) return true;
				return cmp(NOW, w.end) > 0 && curW.key !== ppe.window;
			}
			if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) {
				ppeDot.className = 'w-2 h-2 bg-green-500 rounded-full';
				ppeText.textContent = '本时窗 PPE：已完成';
				ppeMeta.textContent = ppe.time + ' · ' + (ppe.operators || '');
				ppeBtn.textContent = '查看留痕';
				ppeBtn.href = '#';
				ppeBtn.onclick = function (e) {
					e.preventDefault();
					alert('PPE 留痕：' + ppe.time + ' ' + (ppe.operators || ''));
				};
			} else if (ppe && isExpired()) {
				ppeDot.className = 'w-2 h-2 bg-orange-500 rounded-full';
				ppeText.textContent = '本时窗 PPE：已过期';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '重新采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-flat.html&tw=' + encodeURIComponent(curW.key);
			} else {
				ppeText.textContent = '本时窗 PPE：未完成';
				ppeMeta.textContent = '目标时窗：' + curW.key.replace('-', '–');
				ppeBtn.textContent = '去采集';
				ppeBtn.href = 'ppe-session.html?from=task-list-flat.html&tw=' + encodeURIComponent(curW.key);
			}

			// ===== 扁平任务数据 =====
			const DEV = { id: 'DEV-001', name: '供水泵#1', site: '一号厂 · 南区' };
			const PROJECTS = [
				{ id: 'TEMP', name: '电机温度', unit: '°C' },
				{ id: 'AMP', name: '运行电流', unit: 'A' },
				{ id: 'VIB', name: '轴承振动', unit: 'mm/s' },
			];
			const rows = [];
			TIME_WINDOWS.forEach((w) => PROJECTS.forEach((p) => rows.push({ dev: DEV, w, p, state: 'UNSTARTED' })));
			rows.forEach((r) => {
				if (cmp(NOW, r.w.start) < 0) r.state = 'NOT_YET';
				else if (cmp(NOW, r.w.end) > 0) r.state = 'OVERDUE';
				else r.state = Math.random() < 0.3 ? 'IN_PROGRESS' : 'OPEN';
			});

			function getStatusBadge(state) {
				const statusMap = {
					NOT_YET: { text: '未到时间', color: 'bg-slate-100 text-slate-600' },
					UNSTARTED: { text: '待领', color: 'bg-slate-100 text-slate-600' },
					OPEN: { text: '可开始', color: 'bg-blue-100 text-blue-700' },
					IN_PROGRESS: { text: '进行中', color: 'bg-green-100 text-green-700' },
					OVERDUE: { text: '逾期', color: 'bg-red-100 text-red-700' },
					DONE: { text: '已完成', color: 'bg-green-100 text-green-700' },
				};
				const status = statusMap[state] || statusMap.UNSTARTED;
				return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status.color}">${status.text}</span>`;
			}

			function getActionButton(state) {
				const disabled = state === 'NOT_YET' || state === 'DONE';
				const buttonText = disabled ? '查看' : '进入';
				const buttonClass = disabled
					? 'px-3 py-1 bg-slate-100 text-slate-700 text-xs font-medium rounded-lg hover:bg-slate-200'
					: 'px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded-lg hover:bg-blue-600';
				const href = disabled ? 'task-detail_all-notyet.html' : 'task-detail_mixed.html';
				return `<a class="${buttonClass} need-ppe" href="${href}">${buttonText}</a>`;
			}

			const list = document.getElementById('list');
			rows.sort((a, b) => a.w.start.localeCompare(b.w.start));
			rows.forEach((r) => {
				const card = document.createElement('div');
				card.className = 'bg-white rounded-2xl shadow-sm p-4';
				card.innerHTML = `
					<div class="flex items-center justify-between">
						<div class="flex-1 min-w-0">
							<div class="flex items-center space-x-2 mb-1">
								<h3 class="text-sm font-semibold text-slate-800">${r.p.name}</h3>
								<span class="text-xs text-slate-500">${r.dev.name}(${r.dev.id})</span>
							</div>
							<div class="text-xs text-slate-500">
								${r.dev.site} · ${r.w.start}–${r.w.end}
							</div>
						</div>
						<div class="flex items-center space-x-2 ml-3">
							${getStatusBadge(r.state)}
							${getActionButton(r.state)}
						</div>
					</div>
				`;
				list.appendChild(card);
			});

			// PPE 拦截
			function ppeGuard(e) {
				if (ppe && ppe.state === 'COMPLETED' && ppe.window === curW.key && !isExpired()) return true;
				e.preventDefault();
				const url =
					'ppe-session.html?from=' +
					encodeURIComponent('task-list-flat.html') +
					'&tw=' +
					encodeURIComponent(curW.key);
				location.href = url;
				return false;
			}
			Array.from(document.querySelectorAll('.need-ppe')).forEach((el) => el.addEventListener('click', ppeGuard));
		</script>
	</body>
</html>
